// Prisma Schema â€” MultiNegÃ³cios Locais
// Blueprint: BP-2026-02-28-001 (CRM Prospects & Dashboard Vendedores)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODELOS PRINCIPAIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Prospect {
  id        String   @id @default(cuid())
  placeId   String?
  nome      String
  email     String?
  telefone  String?
  negocio   String?
  segmento  String?
  cidade    String?
  estado    String?
  score     Int?
  analise   Json?

  // ğŸ†• Campos CRM (BP-2026-02-28-001)
  vendedorId     String?
  vendedor       User?     @relation("VendedorProspects", fields: [vendedorId], references: [id])
  statusPipeline String    @default("NOVO") // NOVO, EM_CONTATO, REUNIAO_AGENDADA, PROPOSTA_ENVIADA, NEGOCIANDO, CONTRATO_ENVIADO, ASSINADO, PAGO, PERDIDO, INATIVO
  origem         String    @default("CAPTACAO_ATIVA") // LP, CAPTACAO_ATIVA, INDICACAO
  observacoes    String?   @db.Text
  proximoContato DateTime?
  valorEstimado  Decimal?  @db.Decimal(10, 2)

  // Relacionamentos
  interacoes     Interacao[] @relation("ProspectInteracoes")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([placeId])
  @@index([createdAt])
  @@index([vendedorId])
  @@index([statusPipeline])
  @@index([origem])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADS (Captura de dados + AnÃ¡lise interna)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Lead {
  id              String    @id @default(cuid())

  // Dados de contato
  nome            String
  email           String
  telefone        String
  whatsapp        String?
  negocio         String              // Nome do negÃ³cio
  siteUrl         String?             // URL do site (se tiver)
  segmento        String              // Categoria do negÃ³cio

  // Dados do Google Business
  placeId         String?             // ID do Google Places
  enderecoGoogle  String?

  // Scores (visÃ­veis para o cliente)
  scoreGeral      Int?
  scoreGBP        Int?
  scoreSite       Int?
  scoreRedes      Int?

  // AnÃ¡lise detalhada (INTERNO - nÃ£o mostra para cliente)
  analiseCompleta Json?               // DiagnÃ³stico detalhado completo
  argumentosFechamento Json?          // Lista de argumentos de venda
  planoAcao       Json?               // Plano de aÃ§Ã£o sugerido

  // Proposta gerada pelo agente
  proposta        Json?               // Proposta de precificaÃ§Ã£o
  valorSugerido   Decimal?  @db.Decimal(10, 2)

  // Status do lead
  status          String    @default("NOVO") // NOVO, CONTATADO, NEGOCIANDO, CONVERTIDO, PERDIDO
  motivoPerda     String?             // Se perdido, qual o motivo
  observacoes     String?             // Notas internas

  // ConversÃ£o
  convertido      Boolean   @default(false)
  clienteId       String?   @unique
  cliente         Cliente?  @relation(fields: [clienteId], references: [id])

  // Rastreamento
  origem          String?             // De onde veio (google, instagram, direto, etc)
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?

  // ğŸ†• Vendedor atribuÃ­do (BP-2026-02-28-001)
  vendedorId      String?
  vendedor        User?     @relation("VendedorLeads", fields: [vendedorId], references: [id])

  // Relacionamentos
  interacoes      Interacao[] @relation("LeadInteracoes")

  // Timestamps
  pesquisaEm      DateTime  @default(now())  // Data/hora da pesquisa
  contatadoEm     DateTime?                   // Quando foi contatado
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([convertido])
  @@index([pesquisaEm])
  @@index([segmento])
  @@index([vendedorId])
}

model Cliente {
  id        String     @id @default(cuid())
  nome      String
  email     String
  telefone  String
  cpfCnpj   String
  negocio   String
  endereco  Json?
  planoId   String?
  plano     Plano?     @relation(fields: [planoId], references: [id])
  contratos Contrato[]
  lead      Lead?                   // Lead que originou este cliente
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([email])
  @@index([cpfCnpj])
}

model Contrato {
  id         String      @id @default(cuid())
  clienteId  String
  cliente    Cliente     @relation(fields: [clienteId], references: [id])
  valor      Decimal     @db.Decimal(10, 2)
  parcelas   Int
  status     String      @default("PENDENTE") // PENDENTE, ASSINADO, PAGO, CANCELADO
  pdfUrl     String?
  assinadoEm DateTime?
  pagamentos Pagamento[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([clienteId])
  @@index([status])
}

model Pagamento {
  id         String   @id @default(cuid())
  contratoId String
  contrato   Contrato @relation(fields: [contratoId], references: [id])
  valor      Decimal  @db.Decimal(10, 2)
  parcela    Int      @default(1)
  status     String   @default("PENDENTE") // PENDENTE, PROCESSANDO, PAGO, FALHOU
  mpId       String?  // ID do Mercado Pago
  nfeUrl     String?
  nfeNumero  String?
  paidAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([contratoId])
  @@index([status])
  @@index([mpId])
}

model Plano {
  id          String    @id @default(cuid())
  nome        String
  descricao   String?
  implantacao Decimal   @db.Decimal(10, 2)
  mensalidade Decimal   @db.Decimal(10, 2)
  parcelas    Int
  ativo       Boolean   @default(true)
  clientes    Cliente[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([ativo])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTENTICAÃ‡ÃƒO ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          String    @default("vendedor") // admin, vendedor
  ativo         Boolean   @default(true)
  emailVerified DateTime?

  // Dados pessoais do vendedor
  cpf           String?
  rg            String?
  comissao      Decimal?  @db.Decimal(5, 2) // Porcentagem (ex: 10.00 = 10%)

  // ğŸ†• Relacionamentos CRM (BP-2026-02-28-001)
  prospectsAtribuidos Prospect[] @relation("VendedorProspects")
  leadsAtribuidos     Lead[]     @relation("VendedorLeads")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([role])
  @@index([ativo])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOLLOW-UP AUTOMÃTICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model FollowUp {
  id            String    @id @default(cuid())
  leadId        String

  // Agendamento
  tipo          String    // PRIMEIRO_CONTATO, SEGUNDO_CONTATO, TERCEIRO_CONTATO, PROPOSTA, FECHAMENTO
  agendadoPara  DateTime  // Data/hora agendada

  // Status
  status        String    @default("PENDENTE") // PENDENTE, ENVIADO, REALIZADO, CANCELADO
  executadoEm   DateTime?

  // ConteÃºdo
  assunto       String?
  mensagem      String?   @db.Text
  canal         String    @default("EMAIL") // EMAIL, WHATSAPP, TELEFONE

  // Resultado (apÃ³s execuÃ§Ã£o)
  resultado     String?   // SUCESSO, SEM_RESPOSTA, NEGATIVO, REAGENDAR
  observacoes   String?   @db.Text

  // Rastreamento
  tentativas    Int       @default(0)
  ultimaTentativa DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([leadId])
  @@index([status])
  @@index([agendadoPara])
  @@index([tipo])
}

model FollowUpTemplate {
  id            String    @id @default(cuid())

  // IdentificaÃ§Ã£o
  nome          String    @unique
  tipo          String    // PRIMEIRO_CONTATO, SEGUNDO_CONTATO, etc
  canal         String    // EMAIL, WHATSAPP

  // ConteÃºdo
  assunto       String?   // Para email
  mensagem      String    @db.Text

  // Timing
  diasAposEvento Int      @default(1) // Dias apÃ³s evento anterior
  horaEnvio     String    @default("10:00") // Hora preferencial de envio

  // Status
  ativo         Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tipo])
  @@index([ativo])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• INTERAÃ‡Ã•ES / TIMELINE (BP-2026-02-28-001)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Interacao {
  id          String    @id @default(cuid())

  // Pode ser de Prospect OU Lead
  prospectId  String?
  leadId      String?
  prospect    Prospect? @relation("ProspectInteracoes", fields: [prospectId], references: [id], onDelete: Cascade)
  lead        Lead?     @relation("LeadInteracoes", fields: [leadId], references: [id], onDelete: Cascade)

  // Tipo de interaÃ§Ã£o
  tipo        String    // LIGACAO, EMAIL, WHATSAPP, REUNIAO, NOTA, STATUS_CHANGE

  // ConteÃºdo
  descricao   String    @db.Text

  // Quem criou
  criadoPorId String    // ID do usuÃ¡rio
  criadoPor   String    // Nome do usuÃ¡rio (denormalizado para histÃ³rico)

  // Metadados opcionais (ex: { de: "NOVO", para: "EM_CONTATO" } para STATUS_CHANGE)
  metadata    Json?

  createdAt   DateTime  @default(now())

  @@index([prospectId])
  @@index([leadId])
  @@index([tipo])
  @@index([createdAt])
}
