generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Cliente {
  id         String     @id @default(cuid())
  nome       String
  email      String
  telefone   String
  cpfCnpj    String
  negocio    String
  endereco   Json?
  planoId    String?
  vendedorId String?
  prospectId String?    @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  plano      Plano?     @relation(fields: [planoId], references: [id])
  vendedor   User?      @relation("ClientesVendedor", fields: [vendedorId], references: [id])
  prospect   Prospect?  @relation(fields: [prospectId], references: [id])
  contratos  Contrato[]
  lead       Lead?

  @@index([cpfCnpj])
  @@index([email])
  @@index([vendedorId])
  @@index([prospectId])
}

model Contrato {
  id                 String      @id @default(cuid())
  clienteId          String
  valor              Decimal     @db.Decimal(10, 2)
  parcelas           Int
  valorMensal        Decimal?    @db.Decimal(10, 2)
  incluiGestaoMensal Boolean     @default(false)
  status             String      @default("PENDENTE")
  pdfUrl             String?
  assinadoEm         DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  cliente            Cliente     @relation(fields: [clienteId], references: [id])
  pagamentos         Pagamento[]

  @@index([clienteId])
  @@index([status])
}

model FollowUp {
  id              String    @id @default(cuid())
  leadId          String
  tipo            String
  agendadoPara    DateTime
  status          String    @default("PENDENTE")
  executadoEm     DateTime?
  assunto         String?
  mensagem        String?
  canal           String    @default("EMAIL")
  resultado       String?
  observacoes     String?
  tentativas      Int       @default(0)
  ultimaTentativa DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([agendadoPara])
  @@index([leadId])
  @@index([status])
  @@index([tipo])
}

model FollowUpTemplate {
  id             String   @id @default(cuid())
  nome           String   @unique
  tipo           String
  canal          String
  assunto        String?
  mensagem       String
  diasAposEvento Int      @default(1)
  horaEnvio      String   @default("10:00")
  ativo          Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([ativo])
  @@index([tipo])
}

model Interacao {
  id          String    @id @default(cuid())
  prospectId  String?
  leadId      String?
  tipo        String
  descricao   String
  criadoPorId String
  criadoPor   String
  metadata    Json?
  createdAt   DateTime  @default(now())
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  prospect    Prospect? @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([prospectId])
  @@index([tipo])
}

model Lead {
  id                   String      @id @default(cuid())
  nome                 String
  email                String
  telefone             String
  whatsapp             String?
  negocio              String
  siteUrl              String?
  segmento             String
  placeId              String?
  enderecoGoogle       String?
  scoreGeral           Int?
  scoreGBP             Int?
  scoreSite            Int?
  scoreRedes           Int?
  analiseCompleta      Json?
  argumentosFechamento Json?
  planoAcao            Json?
  proposta             Json?
  valorSugerido        Decimal?    @db.Decimal(10, 2)
  status               String      @default("NOVO")
  motivoPerda          String?
  observacoes          String?
  convertido           Boolean     @default(false)
  clienteId            String?     @unique
  origem               String?
  utmSource            String?
  utmMedium            String?
  utmCampaign          String?
  pesquisaEm           DateTime    @default(now())
  contatadoEm          DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  vendedorId           String?
  interacoes           Interacao[]
  cliente              Cliente?    @relation(fields: [clienteId], references: [id])
  vendedor             User?       @relation(fields: [vendedorId], references: [id])

  @@index([convertido])
  @@index([email])
  @@index([pesquisaEm])
  @@index([segmento])
  @@index([status])
  @@index([vendedorId])
}

model Pagamento {
  id         String    @id @default(cuid())
  contratoId String
  valor      Decimal   @db.Decimal(10, 2)
  parcela    Int       @default(1)
  status     String    @default("PENDENTE")
  mpId       String?
  nfeUrl     String?
  nfeNumero  String?
  paidAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  contrato   Contrato  @relation(fields: [contratoId], references: [id])

  @@index([contratoId])
  @@index([mpId])
  @@index([status])
}

model Plano {
  id          String    @id @default(cuid())
  nome        String
  descricao   String?
  implantacao Decimal   @db.Decimal(10, 2)
  mensalidade Decimal   @db.Decimal(10, 2)
  parcelas    Int
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  clientes    Cliente[]

  @@index([ativo])
}

model Prospect {
  id             String      @id @default(cuid())
  placeId        String?
  nome           String
  email          String?
  telefone       String?
  score          Int?
  analise        Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  cidade         String?
  estado         String?
  negocio        String?
  observacoes    String?
  origem         String      @default("CAPTACAO_ATIVA")
  proximoContato DateTime?
  segmento       String?
  statusPipeline String      @default("NOVO")
  valorEstimado  Decimal?    @db.Decimal(10, 2)
  vendedorId     String?
  interacoes     Interacao[]
  vendedor       User?       @relation(fields: [vendedorId], references: [id])
  cliente        Cliente?

  @@index([createdAt])
  @@index([origem])
  @@index([placeId])
  @@index([statusPipeline])
  @@index([vendedorId])
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  password      String
  role          String     @default("vendedor")
  emailVerified DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  ativo         Boolean    @default(true)
  comissao      Decimal?   @db.Decimal(5, 2)
  cpf           String?
  rg            String?
  leads         Lead[]
  prospects     Prospect[]
  clientes      Cliente[]  @relation("ClientesVendedor")

  @@index([ativo])
  @@index([role])
}
