// Prisma Schema — MultiNegócios Locais
// Blueprint: BP-2026-02-22-001

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════════════════════════
// MODELOS PRINCIPAIS
// ═══════════════════════════════════════════════════════════════

model Prospect {
  id        String   @id @default(cuid())
  placeId   String
  nome      String
  email     String?
  telefone  String?
  score     Int
  analise   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([placeId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════
// LEADS (Captura de dados + Análise interna)
// ═══════════════════════════════════════════════════════════════

model Lead {
  id              String    @id @default(cuid())

  // Dados de contato
  nome            String
  email           String
  telefone        String
  whatsapp        String?
  negocio         String              // Nome do negócio
  siteUrl         String?             // URL do site (se tiver)
  segmento        String              // Categoria do negócio

  // Dados do Google Business
  placeId         String?             // ID do Google Places
  enderecoGoogle  String?

  // Scores (visíveis para o cliente)
  scoreGeral      Int?
  scoreGBP        Int?
  scoreSite       Int?
  scoreRedes      Int?

  // Análise detalhada (INTERNO - não mostra para cliente)
  analiseCompleta Json?               // Diagnóstico detalhado completo
  argumentosFechamento Json?          // Lista de argumentos de venda
  planoAcao       Json?               // Plano de ação sugerido

  // Proposta gerada pelo agente
  proposta        Json?               // Proposta de precificação
  valorSugerido   Decimal?  @db.Decimal(10, 2)

  // Status do lead
  status          String    @default("NOVO") // NOVO, CONTATADO, NEGOCIANDO, CONVERTIDO, PERDIDO
  motivoPerda     String?             // Se perdido, qual o motivo
  observacoes     String?             // Notas internas

  // Conversão
  convertido      Boolean   @default(false)
  clienteId       String?   @unique
  cliente         Cliente?  @relation(fields: [clienteId], references: [id])

  // Rastreamento
  origem          String?             // De onde veio (google, instagram, direto, etc)
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?

  // Timestamps
  pesquisaEm      DateTime  @default(now())  // Data/hora da pesquisa
  contatadoEm     DateTime?                   // Quando foi contatado
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([convertido])
  @@index([pesquisaEm])
  @@index([segmento])
}

model Cliente {
  id        String     @id @default(cuid())
  nome      String
  email     String
  telefone  String
  cpfCnpj   String
  negocio   String
  endereco  Json?
  planoId   String?
  plano     Plano?     @relation(fields: [planoId], references: [id])
  contratos Contrato[]
  lead      Lead?                   // Lead que originou este cliente
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([email])
  @@index([cpfCnpj])
}

model Contrato {
  id         String      @id @default(cuid())
  clienteId  String
  cliente    Cliente     @relation(fields: [clienteId], references: [id])
  valor      Decimal     @db.Decimal(10, 2)
  parcelas   Int
  status     String      @default("PENDENTE") // PENDENTE, ASSINADO, PAGO, CANCELADO
  pdfUrl     String?
  assinadoEm DateTime?
  pagamentos Pagamento[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([clienteId])
  @@index([status])
}

model Pagamento {
  id         String   @id @default(cuid())
  contratoId String
  contrato   Contrato @relation(fields: [contratoId], references: [id])
  valor      Decimal  @db.Decimal(10, 2)
  parcela    Int      @default(1)
  status     String   @default("PENDENTE") // PENDENTE, PROCESSANDO, PAGO, FALHOU
  mpId       String?  // ID do Mercado Pago
  nfeUrl     String?
  nfeNumero  String?
  paidAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([contratoId])
  @@index([status])
  @@index([mpId])
}

model Plano {
  id          String    @id @default(cuid())
  nome        String
  descricao   String?
  implantacao Decimal   @db.Decimal(10, 2)
  mensalidade Decimal   @db.Decimal(10, 2)
  parcelas    Int
  ativo       Boolean   @default(true)
  clientes    Cliente[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([ativo])
}

// ═══════════════════════════════════════════════════════════════
// AUTENTICAÇÃO ADMIN
// ═══════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          String    @default("admin") // admin, viewer
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
